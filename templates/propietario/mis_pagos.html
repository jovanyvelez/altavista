{% extends "base.html" %}

{% block title %}Mis Pagos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-credit-card"></i> Mis Pagos - Apartamento {{ apartamento.identificador }}
        </h1>
        <a href="/propietario/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Panel
        </a>
    </div>

    <!-- Estado General -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white {{ 'bg-success' if saldo_total <= 0 else 'bg-danger' if saldo_total > 1000 else 'bg-warning' }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Estado Actual</h6>
                            <h3 class="mb-0">
                                {% if saldo_total <= 0 %}
                                    AL DÍA
                                {% elif saldo_total <= 1000 %}
                                    PENDIENTE
                                {% else %}
                                    EN MORA
                                {% endif %}
                            </h3>
                        </div>
                        <i class="fas fa-{{ 'check-circle' if saldo_total <= 0 else 'exclamation-triangle' }} fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Saldo Total</h6>
                            <h3 class="mb-0">${{ "%.2f"|format(saldo_total) }}</h3>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Total Pagado {{ now().year }}</h6>
                            <h3 class="mb-0">${{ "%.2f"|format(total_pagado_año) }}</h3>
                        </div>
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Períodos Pendientes</h6>
                            <h3 class="mb-0">{{ periodos_pendientes }}</h3>
                        </div>
                        <i class="fas fa-calendar-times fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cuotas Configuradas para el Año Actual -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-calendar"></i> Cuotas Configuradas - {{ now().year }}
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Mes</th>
                            {% for i in range(1, 13) %}
                            <th class="text-center">
                                {{ ["", "Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"][i] }}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="fw-bold">Cuota Configurada</td>
                            {% for i in range(1, 13) %}
                            <td class="text-center">
                                {% set config = configuraciones_cuotas.get(i) %}
                                {% if config %}
                                    ${{ "%.2f"|format(config.monto_cuota_ordinaria_mensual) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td class="fw-bold">Estado</td>
                            {% for i in range(1, 13) %}
                            <td class="text-center">
                                {% set estado = estados_pago.get(i, 'pendiente') %}
                                <span class="badge bg-{{ 'success' if estado == 'pagado' else 'danger' if estado == 'vencido' else 'warning' }}">
                                    {{ estado.title() }}
                                </span>
                            </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Historial de Movimientos -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-history"></i> Historial de Movimientos
            </h5>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="filtrarMovimientos('todos')">Todos</button>
                <button class="btn btn-outline-success" onclick="filtrarMovimientos('pagos')">Pagos</button>
                <button class="btn btn-outline-danger" onclick="filtrarMovimientos('cargos')">Cargos</button>
                <button class="btn btn-outline-info" onclick="filtrarMovimientos('año_actual')">{{ now().year }}</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th>Período</th>
                            <th>Descripción</th>
                            <th>Cargo</th>
                            <th>Abono</th>
                            <th>Referencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registro in registros_financieros %}
                        <tr class="fila-movimiento" 
                            data-tipo="{{ registro.tipo_movimiento.value }}"
                            data-año="{{ registro.año_aplicable or now().year }}">
                            <td>{{ registro.fecha_efectiva.strftime("%d/%m/%Y") }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ registro.concepto.nombre }}</span>
                            </td>
                            <td>
                                {% if registro.mes_aplicable and registro.año_aplicable %}
                                    {{ ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][registro.mes_aplicable] }} {{ registro.año_aplicable }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ registro.descripcion_adicional or "-" }}</td>
                            <td class="text-end">
                                {% if registro.tipo_movimiento.value == "cargo" %}
                                    <span class="text-danger fw-bold">${{ "%.2f"|format(registro.monto) }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if registro.tipo_movimiento.value == "abono" %}
                                    <span class="text-success fw-bold">${{ "%.2f"|format(registro.monto) }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if registro.referencia_pago %}
                                    <small class="text-muted">{{ registro.referencia_pago }}</small>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr class="fw-bold">
                            <td colspan="4">SALDO TOTAL:</td>
                            <td class="text-end text-danger">${{ "%.2f"|format(total_cargos) }}</td>
                            <td class="text-end text-success">${{ "%.2f"|format(total_abonos) }}</td>
                            <td class="text-end {{ 'text-success' if saldo_total <= 0 else 'text-danger' }}">
                                ${{ "%.2f"|format(saldo_total) }}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Información de Contacto y Métodos de Pago -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card"></i> Métodos de Pago
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="text-center mb-3">
                                <i class="fas fa-university fa-3x text-primary mb-2"></i>
                                <h6>Transferencia Bancaria</h6>
                                <p class="text-muted small">
                                    Banco: Banco Nacional<br>
                                    Cuenta: 123-456-789<br>
                                    A nombre de: Edificio ABC
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center mb-3">
                                <i class="fas fa-money-bill fa-3x text-success mb-2"></i>
                                <h6>Pago en Efectivo</h6>
                                <p class="text-muted small">
                                    En administración<br>
                                    Lunes a Viernes<br>
                                    8:00 AM - 5:00 PM
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {% if saldo_total > 0 %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>¿Realizaste un pago?</strong> 
                        Contáctanos para registrarlo en el sistema.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-phone"></i> Información de Contacto
                    </h5>
                </div>
                <div class="card-body">
                    <address class="mb-3">
                        <strong>Administración del Edificio</strong><br>
                        <i class="fas fa-envelope"></i> admin@edificio.com<br>
                        <i class="fas fa-phone"></i> (555) 123-4567<br>
                        <i class="fas fa-whatsapp"></i> WhatsApp: (555) 987-6543<br>
                        <i class="fas fa-clock"></i> Lunes a Viernes, 8:00 AM - 5:00 PM
                    </address>
                    
                    <hr>
                    
                    <h6>Consultas Frecuentes:</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-question-circle text-info"></i> ¿Cómo registro un pago?</li>
                        <li><i class="fas fa-question-circle text-info"></i> ¿Cuándo se generan las cuotas?</li>
                        <li><i class="fas fa-question-circle text-info"></i> ¿Hay intereses por mora?</li>
                    </ul>
                    
                    <button class="btn btn-outline-primary btn-sm" onclick="abrirChat()">
                        <i class="fas fa-comments"></i> Contactar Administración
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    {% if saldo_total > 0 %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-bolt"></i> Acciones Rápidas
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <button class="btn btn-success w-100" onclick="reportarPago()">
                        <i class="fas fa-plus"></i> Reportar Pago Realizado
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" onclick="descargarEstadoCuenta()">
                        <i class="fas fa-download"></i> Descargar Estado de Cuenta
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-info w-100" onclick="solicitudPlan()">
                        <i class="fas fa-calendar"></i> Solicitar Plan de Pagos
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-warning w-100" onclick="contactarAdmin()">
                        <i class="fas fa-headset"></i> Contactar Administración
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Reportar Pago -->
<div class="modal fade" id="modalReportarPago" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Reportar Pago Realizado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/propietario/reportar-pago">
                <div class="modal-body">
                    <input type="hidden" name="apartamento_id" value="{{ apartamento.id }}">
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Use este formulario para reportar un pago que ya realizó. 
                        La administración verificará y registrará su pago.
                    </div>
                    
                    <div class="mb-3">
                        <label for="monto_reportado" class="form-label">Monto Pagado *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   name="monto_reportado" 
                                   id="monto_reportado" 
                                   step="0.01" 
                                   min="0.01" 
                                   max="{{ saldo_total }}"
                                   required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fecha_pago_reportado" class="form-label">Fecha del Pago *</label>
                        <input type="date" 
                               class="form-control" 
                               name="fecha_pago_reportado" 
                               id="fecha_pago_reportado" 
                               max="{{ now().strftime('%Y-%m-%d') }}"
                               required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="metodo_pago" class="form-label">Método de Pago *</label>
                        <select class="form-select" name="metodo_pago" id="metodo_pago" required>
                            <option value="">Seleccionar método...</option>
                            <option value="transferencia">Transferencia Bancaria</option>
                            <option value="efectivo">Efectivo en Administración</option>
                            <option value="cheque">Cheque</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="referencia_reportada" class="form-label">Referencia/Comprobante</label>
                        <input type="text" 
                               class="form-control" 
                               name="referencia_reportada" 
                               id="referencia_reportada" 
                               placeholder="Número de transferencia, recibo, etc.">
                    </div>
                    
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" 
                                  name="observaciones" 
                                  id="observaciones" 
                                  rows="2" 
                                  placeholder="Información adicional sobre el pago..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> Enviar Reporte
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Filtrar movimientos
function filtrarMovimientos(tipo) {
    const filas = document.querySelectorAll('.fila-movimiento');
    
    filas.forEach(fila => {
        let mostrar = false;
        const tipoMovimiento = fila.dataset.tipo;
        const añoMovimiento = fila.dataset.año;
        
        switch(tipo) {
            case 'todos':
                mostrar = true;
                break;
            case 'pagos':
                mostrar = tipoMovimiento === 'abono';
                break;
            case 'cargos':
                mostrar = tipoMovimiento === 'cargo';
                break;
            case 'año_actual':
                mostrar = añoMovimiento === '{{ now().year }}';
                break;
        }
        
        fila.style.display = mostrar ? '' : 'none';
    });
}

// Reportar pago
function reportarPago() {
    $('#modalReportarPago').modal('show');
}

// Funciones de acciones rápidas
function descargarEstadoCuenta() {
    window.open('/propietario/estado-cuenta/{{ apartamento.id }}/pdf', '_blank');
}

function solicitudPlan() {
    alert('Función de plan de pagos en desarrollo. Contacte a la administración para solicitar un plan de pagos.');
}

function contactarAdmin() {
    window.open('mailto:admin@edificio.com?subject=Consulta Apartamento {{ apartamento.identificador }}&body=Estimada administración, tengo una consulta sobre mi apartamento {{ apartamento.identificador }}:', '_blank');
}

function abrirChat() {
    // Simular apertura de chat
    alert('Chat en desarrollo. Por favor use los métodos de contacto tradicionales.');
}

// Auto-refresh cada 10 minutos para datos actualizados
setTimeout(function() {
    window.location.reload();
}, 600000);
</script>
{% endblock %}
