{% extends "base.html" %}

{% block title %}Generación Automática V3 - Cuotas + Intereses{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-cogs"></i> Generación Automática V3 - Cuotas + Intereses
        </h1>
        <div class="btn-group">
            <a href="/admin/pagos" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Pagos
            </a>
            <a href="/admin/pagos/generar-cargos" class="btn btn-outline-primary">
                <i class="fas fa-plus-circle"></i> Generación Básica
            </a>
        </div>
    </div>

    <!-- Alertas -->
    {% if request.query_params.get('success') %}
    <div class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i> 
        <strong>¡Generación completada exitosamente!</strong>
        {% if request.query_params.get('mes') and request.query_params.get('año') %}
        <br>Período: {{ ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][request.query_params.get('mes')|int] }} {{ request.query_params.get('año') }}
        {% endif %}
        {% if request.query_params.get('cuotas') %}
        <br><strong>Cuotas ordinarias:</strong> {{ request.query_params.get('cuotas') }} generadas por ${{ "{:,.2f}".format(request.query_params.get('monto_cuotas')|float) }}
        {% endif %}
        {% if request.query_params.get('intereses') %}
        <br><strong>Intereses moratorios:</strong> {{ request.query_params.get('intereses') }} generados por ${{ "{:,.2f}".format(request.query_params.get('monto_intereses')|float) }}
        {% endif %}
        {% if request.query_params.get('errores') %}
        <br><span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Se presentaron {{ request.query_params.get('errores') }} errores durante el procesamiento</span>
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if request.query_params.get('info') == 'already_processed' %}
    <div class="alert alert-info alert-dismissible fade show">
        <i class="fas fa-info-circle"></i> 
        El período {{ ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][request.query_params.get('mes')|int] }} {{ request.query_params.get('año') }} ya fue procesado anteriormente.
        <br>Use la opción "Forzar reprocesamiento" si necesita regenerar los cargos.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if request.query_params.get('error') %}
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-triangle"></i> 
        Error durante el procesamiento.
        {% if request.query_params.get('details') %}
        <br>Detalles: {{ request.query_params.get('details') }}
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-md-8">
            <!-- Formulario de Generación -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-magic"></i> Procesamiento Automático V3
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Sistema Integrado V3</h6>
                        <p class="mb-0">Este sistema genera automáticamente:</p>
                        <ul class="mb-0 mt-2">
                            <li><strong>Cuotas ordinarias</strong> basadas en la configuración por apartamento</li>
                            <li><strong>Intereses moratorios</strong> calculados automáticamente sobre saldos pendientes</li>
                            <li><strong>Control de duplicados</strong> para evitar reprocessamientos accidentales</li>
                            <li><strong>Auditoría completa</strong> del procesamiento realizado</li>
                        </ul>
                    </div>

                    <form method="post" action="/admin/pagos/generar-automatico" id="formGenerarAutomatico">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="año" class="form-label">Año *</label>
                                    <select class="form-select" name="año" id="año" required>
                                        {% for i in range(año_actual - 2, año_actual + 3) %}
                                        <option value="{{ i }}" {% if i == año_actual %}selected{% endif %}>{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mes" class="form-label">Mes *</label>
                                    <select class="form-select" name="mes" id="mes" required>
                                        {% for i in range(1, 13) %}
                                        <option value="{{ i }}" {% if i == mes_actual %}selected{% endif %}>
                                            {{ ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][i] }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        {% if ya_procesado %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>El mes actual ya fue procesado</strong>
                            <br>El sistema detectó que {{ ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][mes_actual] }} {{ año_actual }} ya fue procesado anteriormente.
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="forzar" id="forzar" value="true">
                                <label class="form-check-label" for="forzar">
                                    <strong>Forzar reprocesamiento</strong>
                                </label>
                            </div>
                            <div class="form-text text-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                ADVERTENCIA: Esta opción regenerará todos los cargos, incluyendo intereses ya calculados. Use con precaución.
                            </div>
                        </div>
                        {% endif %}

                        <hr>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-outline-info" onclick="verificarEstado()">
                                    <i class="fas fa-search"></i> Verificar Estado
                                </button>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-play"></i> Procesar Mes Completo
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Historial Reciente -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history"></i> Historial de Procesamientos (Últimos 6 meses)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Período</th>
                                    <th>Estado</th>
                                    <th>Cuotas</th>
                                    <th>Intereses</th>
                                    <th>Total $</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in historial %}
                                <tr {% if item.año == año_actual and item.mes == mes_actual %}class="table-warning"{% endif %}>
                                    <td>
                                        <strong>{{ "{:02d}".format(item.mes) }}/{{ item.año }}</strong>
                                    </td>
                                    <td>
                                        {% if item.procesado %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Procesado
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-minus"></i> Pendiente
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.procesado %}
                                        {{ item.cuotas_generadas }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.procesado %}
                                        {{ item.intereses_generados }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.procesado %}
                                        ${{ "{:,.0f}".format(item.monto_cuotas + item.monto_intereses) }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.fecha_procesamiento %}
                                        {{ item.fecha_procesamiento.strftime('%d/%m/%Y %H:%M') }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Estado Actual -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> Estado del Sistema
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Mes actual:</span>
                            <strong>{{ "{:02d}".format(mes_actual) }}/{{ año_actual }}</strong>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Configuraciones:</span>
                            <span class="badge bg-{{ 'success' if configuraciones_disponibles > 0 else 'warning' }}">
                                {{ configuraciones_disponibles }} apartamentos
                            </span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Tasa de interés:</span>
                            {% if tasa_interes %}
                            <span class="badge bg-info">
                                {{ (tasa_interes.tasa_interes_mensual * 100)|round(2) }}% mensual
                            </span>
                            {% else %}
                            <span class="badge bg-warning">No configurada</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Estado actual:</span>
                            {% if ya_procesado %}
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> Procesado
                            </span>
                            {% else %}
                            <span class="badge bg-warning">
                                <i class="fas fa-clock"></i> Pendiente
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <hr>

                    {% if control_actual %}
                    <h6 class="text-success">Último Procesamiento</h6>
                    <small class="text-muted d-block">{{ control_actual.fecha_procesamiento.strftime('%d/%m/%Y %H:%M:%S') }}</small>
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-primary">{{ control_actual.cuotas_generadas }}</div>
                                <small class="text-muted">Cuotas</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-warning">{{ control_actual.intereses_generados }}</div>
                                <small class="text-muted">Intereses</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <div class="fw-bold text-success">${{ "{:,.0f}".format(control_actual.monto_cuotas + control_actual.monto_intereses) }}</div>
                        <small class="text-muted">Total generado</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Información de la V3 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-star"></i> Características V3
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            Genera cuotas e intereses en una sola operación
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            Control automático de duplicados
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            Cálculo inteligente de intereses moratorios
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            Auditoría completa del procesamiento
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            Manejo robusto de errores y transacciones
                        </li>
                        <li>
                            <i class="fas fa-check text-success"></i>
                            Optimizado para alto rendimiento
                        </li>
                    </ul>

                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="fas fa-lightbulb"></i>
                            <strong>Recomendación:</strong> Ejecute este proceso mensualmente para mantener actualizado el sistema de cargos.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Enlaces Rápidos -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-external-link-alt"></i> Enlaces Relacionados
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/admin/pagos/configuracion" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-cog"></i> Configurar Cuotas
                        </a>
                        <a href="/admin/finanzas#tasas-interes" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-percentage"></i> Tasas de Interés
                        </a>
                        <a href="/admin/pagos/reportes" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-chart-bar"></i> Ver Reportes
                        </a>
                        <a href="/admin/pagos/procesar" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-hand-holding-usd"></i> Procesar Pagos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function verificarEstado() {
    const año = document.getElementById('año').value;
    const mes = document.getElementById('mes').value;
    
    if (!año || !mes) {
        alert('Por favor seleccione año y mes');
        return;
    }
    
    // Aquí podrías hacer una llamada AJAX para verificar el estado
    // Por ahora mostraremos información estática
    alert(`Estado para ${document.querySelector('#mes option:checked').text} ${año}:\n\nEsta funcionalidad mostrará:\n- Configuraciones disponibles\n- Cargos ya generados\n- Última ejecución del procesamiento\n- Estimación de resultados`);
}

// Validación del formulario
document.getElementById('formGenerarAutomatico').addEventListener('submit', function(e) {
    const año = document.getElementById('año').value;
    const mes = document.getElementById('mes').value;
    const forzar = document.getElementById('forzar') ? document.getElementById('forzar').checked : false;
    
    let mensaje = `¿Está seguro de procesar ${document.querySelector('#mes option:checked').text} ${año}?\n\n`;
    mensaje += 'Esta operación generará automáticamente:\n';
    mensaje += '✓ Cuotas ordinarias para todos los apartamentos configurados\n';
    mensaje += '✓ Intereses moratorios sobre saldos pendientes\n';
    mensaje += '✓ Aplicación automática de saldos a favor al próximo período\n';
    mensaje += '✓ Registros de control para evitar duplicados';
    
    if (forzar) {
        mensaje += '\n\n⚠️ ADVERTENCIA: Forzará la regeneración de cargos existentes';
    }
    
    if (!confirm(mensaje)) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
